<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>rp2book.book &mdash; Respec Collection to EPUB</title>
    
    <link rel="stylesheet" href="../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Respec Collection to EPUB" href="../../index.html" />
    <link rel="up" title="rp2book" href="../rp2book.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="../../index.html">
          <span>Respec Collection to EPUB</span></a></h1>
        <h2 class="heading"><span>rp2book.book</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for rp2book.book</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The main controller classes, performing all the steps necessary to produce the book.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">.chapter</span> <span class="kn">import</span> <span class="n">Chapter</span>
<span class="kn">from</span> <span class="nn">.package</span> <span class="kn">import</span> <span class="n">generate_opf</span><span class="p">,</span> <span class="n">generate_nav</span><span class="p">,</span> <span class="n">generate_ncx</span><span class="p">,</span> <span class="n">generate_cover</span>
<span class="kn">from</span> <span class="nn">.overview</span> <span class="kn">import</span> <span class="n">convert_overviews</span>
<span class="kn">from</span> <span class="nn">rp2epub.utils</span> <span class="kn">import</span> <span class="n">HttpSession</span>
<span class="kn">from</span> <span class="nn">rp2epub</span> <span class="kn">import</span> <span class="n">R2EError</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">zipfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="c1"># noinspection PyPep8Naming</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">as</span> <span class="nn">ET</span>


<span class="c1"># noinspection PyPep8</span>
<span class="c1"># noinspection PyBroadException,PyUnusedLocal</span>
<div class="viewcode-block" id="Config"><a class="viewcode-back" href="../../book.html#rp2book.book.Config">[docs]</a><span class="k">class</span> <span class="nc">Config</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    “Configuration” class, collecting all necessary information on the book (and its chapters) that are necessary for</span>
<span class="sd">    further processing. Most of the data are collected in the initialization phase by extracting it from the</span>
<span class="sd">    JSON or YAML data provided by the user, other data are refreshed/added by the :py:class:`Book` instance making use of</span>
<span class="sd">    this class.</span>

<span class="sd">    The only processing part of this class is establishing the chapter sources. If the sources are epub files (either</span>
<span class="sd">    locally or via an HTTP(S) URI), the content is unpacked on the fly into a temporary directory. This means that,</span>
<span class="sd">    as far as the upper layers are concerned, chapter sources are always viewed as directory names on the local file system.</span>

<span class="sd">    Before processing further, a sanity check on the configuration file is also performed, raising an exception in case</span>
<span class="sd">    of a problem. The attributes of the class are:</span>

<span class="sd">    :py:attr:`title`: Title of the book</span>

<span class="sd">    :py:attr:`id`: Unique ID of the book</span>

<span class="sd">    :py:attr:`target`: Target name of the generated EPUB and/or the generated folder</span>

<span class="sd">    :py:attr:`sources`: Array of chapter references, referring to folders on the local file system</span>

<span class="sd">    :py:attr:`chapters`: Array of :py:class:`.chapter.Chapter` references, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`date`: Date of publication, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`toRemoveDir`: Temporary directory storing, possibly, unpacked epub instances for further processing. The directory is removed at closure, see :py:meth:`.close`.</span>

<span class="sd">    :py:attr:`editors`: Collected editors, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`opf`: An :py:class:`ElementTree.Element` object, representing the final OPF file, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`nav`: An :py:class:`ElementTree.Element` object, representing the final NAV file, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`ncx`: An :py:class:`ElementTree.Element` object, representing the final NCX file, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`ncx`: An :py:class:`ElementTree.Element` object, representing the final cover page, filled by the enclosing object at initialization time</span>

<span class="sd">    :py:attr:`uri_patterns`: Array of (`from`,`to`) pairs of URI-s (`to` is typically a relative URI) to replace URI references in the various Overview files.</span>

<span class="sd">    &quot;&quot;&quot;</span>
	<span class="c1"># noinspection PyPep8</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_config_source</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param json_config_source: file name for the json configuration file</span>
<span class="sd">        :type json_config_source: string</span>
<span class="sd">        :raises: :py:exc:`.R2BError`: raised if the JSON parsing leads to problems, if the configuration is incorrect, or if the HTTP(S) access or the unpacking has issues (if applicable)</span>
<span class="sd">        &quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">json_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_config</span><span class="p">(</span><span class="n">json_config_source</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">R2BError</span>
			<span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
			<span class="k">raise</span> <span class="n">R2BError</span><span class="p">(</span><span class="s2">&quot;Configuration file parsing issues in &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">json_config_source</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

		<span class="c1"># Sanity check on the configuration file</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_check_config</span><span class="p">(</span><span class="n">json_config</span><span class="p">)</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">title</span>  <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">id</span>     <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">&quot;target&quot;</span><span class="p">]</span>

		<span class="c1"># All these must be filled by subsequent calls</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">chapters</span>     <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">sources</span>      <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span>  <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">date</span>         <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">editors</span>      <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">authors</span>      <span class="o">=</span> <span class="p">[]</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">opf</span>          <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">nav</span>          <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ncx</span>          <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">cover</span>        <span class="o">=</span> <span class="bp">None</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">uri_patterns</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="s2">&quot;uripatterns&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">json_config</span> <span class="k">else</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">&quot;uripatterns&quot;</span><span class="p">]]</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">_extract_data</span><span class="p">(</span><span class="n">json_config</span><span class="p">)</span>

<div class="viewcode-block" id="Config._extract_data"><a class="viewcode-back" href="../../book.html#rp2book.book.Config._extract_data">[docs]</a>	<span class="k">def</span> <span class="nf">_extract_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_config</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract books into a temporary directory if the source refers to an EPUB instance rather than a directory.</span>
<span class="sd">        The `sources` array in the object will contain, after this processing, the reference to either the original source (in case that</span>
<span class="sd">        was a directory) or the temporary directory that contains the unpacked book.</span>

<span class="sd">        Processing must end with a call to :py:meth:`close` which ensures a proper closure/removal of the temporary</span>
<span class="sd">        directory.</span>

<span class="sd">        :param json_config: the original JSON configuration file with the array of chapter references</span>
<span class="sd">        &quot;&quot;&quot;</span>
		<span class="c1"># If this detects a problem, an exception is raised!</span>

		<span class="c1"># This is the temporary directory where unpacked books are temporarily placed</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;rp2books_&quot;</span><span class="p">)</span>

		<span class="k">def</span> <span class="nf">create_source</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
			<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If source is a directory, it is returned unchanged. Otherwise it is considered to be a zip file,</span>
<span class="sd">            and is unzipped into the temporary directory.</span>

<span class="sd">            :param source: source name, as provided in the json_config</span>
<span class="sd">            :return: real source path, to be used by further processing</span>
<span class="sd">            &quot;&quot;&quot;</span>
			<span class="k">def</span> <span class="nf">close_and_raise</span><span class="p">(</span><span class="n">error</span><span class="p">):</span>
				<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Close the class (ie, remove the temporary directory) and raise an error</span>

<span class="sd">                :param error: error message string</span>
<span class="sd">                &quot;&quot;&quot;</span>
				<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">R2BError</span>
				<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
				<span class="k">raise</span> <span class="n">R2BError</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
				<span class="k">return</span> <span class="n">source</span>
			<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
				<span class="c1"># Need the basename, this will be used as a source directory name</span>
				<span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
				<span class="c1"># This directory has to be created</span>
				<span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">as</span> <span class="n">the_book</span><span class="p">:</span>
						<span class="n">the_book</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">dir_name</span>
				<span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipfile</span><span class="p">:</span>
					<span class="n">close_and_raise</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a correct zip file&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="c1"># last possibility: this is a URL</span>
				<span class="k">try</span><span class="p">:</span>
					<span class="n">session</span> <span class="o">=</span> <span class="n">HttpSession</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">raise_exception</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span>
					<span class="k">if</span> <span class="n">session</span><span class="o">.</span><span class="n">media_type</span> <span class="o">!=</span> <span class="s2">&quot;application/epub+zip&quot;</span><span class="p">:</span>
						<span class="n">close_and_raise</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not of the correct media type&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">)</span>
					<span class="k">else</span><span class="p">:</span>
						<span class="c1"># The file has to be downloaded to the temporary directory...</span>
						<span class="c1"># First, get the &#39;logical&#39; name that will be used</span>
						<span class="n">path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
						<span class="c1"># this should not happen, but one may never know</span>
						<span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">path</span> <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span> <span class="k">else</span> <span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

						<span class="c1"># Place to download the zip file to:</span>
						<span class="n">downloaded_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span><span class="p">,</span> <span class="s2">&quot;http_download_&quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
						<span class="c1"># Place to unzip the zip file to</span>
						<span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

						<span class="c1"># Download the file from HTTP:</span>
						<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">downloaded_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">downloaded_book</span><span class="p">:</span>
							<span class="n">downloaded_book</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

						<span class="c1"># Unzip it and store it</span>
						<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">downloaded_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">the_book</span><span class="p">:</span>
							<span class="n">the_book</span><span class="o">.</span><span class="n">extractall</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
						<span class="k">return</span> <span class="n">dir_name</span>
				<span class="k">except</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">BadZipfile</span><span class="p">:</span>
					<span class="n">close_and_raise</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39; is not a correct zip file&quot;</span> <span class="o">%</span> <span class="n">source</span><span class="p">)</span>
				<span class="k">except</span> <span class="n">R2EError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
					<span class="n">close_and_raise</span><span class="p">(</span><span class="s2">&quot;Problem accessing &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
				<span class="k">except</span><span class="p">:</span>
					<span class="p">(</span><span class="n">ty</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
					<span class="n">close_and_raise</span><span class="p">(</span><span class="s2">&quot;Problem accessing &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_source</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">json_config</span><span class="p">[</span><span class="s2">&quot;chapters&quot;</span><span class="p">]]</span>
</div>
<div class="viewcode-block" id="Config.close"><a class="viewcode-back" href="../../book.html#rp2book.book.Config.close">[docs]</a>	<span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up the temporary area.</span>

<span class="sd">        Note that the object has `__enter__` and `__exit__` methods (the latter invoking this method), i.e., the object can be used as a context manager.</span>
<span class="sd">        In other words, the object can be (and should be) used via the::</span>

<span class="sd">           with Config(json_file) as config:</span>
<span class="sd">             ...</span>

<span class="sd">        pattern, which ensures that this method will be invoked even if an exception was raised somewhere.</span>
<span class="sd">        &quot;&quot;&quot;</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span><span class="p">)</span>
		<span class="k">except</span><span class="p">:</span>
			<span class="c1"># This means there was no such directory yet; this exception can be ignored</span>
			<span class="k">pass</span>
</div>
	<span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="bp">self</span>

	<span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
		<span class="k">return</span> <span class="bp">False</span>

	<span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Config._check_config"><a class="viewcode-back" href="../../book.html#rp2book.book.Config._check_config">[docs]</a>	<span class="k">def</span> <span class="nf">_check_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the config file. In case of problems an error message is raised in the form of an exception.</span>

<span class="sd">        :param config: config file to check</span>
<span class="sd">        :raises: :py:exc:`.R2BError`</span>
<span class="sd">        &quot;&quot;&quot;</span>
		<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">R2BError</span>
		<span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
			<span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No title is provided&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
			<span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No ID is provided&quot;</span><span class="p">)</span>
		<span class="k">if</span> <span class="s2">&quot;chapters&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;chapters&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
			<span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No chapters are provided&quot;</span><span class="p">)</span>
		<span class="n">chapter_sources</span> <span class="o">=</span> <span class="p">[]</span>
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;chapters&quot;</span><span class="p">]:</span>
			<span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chapter_sources</span><span class="p">:</span>
				<span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Duplicate chapter (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
			<span class="k">else</span><span class="p">:</span>
				<span class="n">chapter_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
			<span class="k">raise</span> <span class="n">R2BError</span><span class="p">(</span><span class="s2">&quot;Error in configuration: &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">config</span>
</div>
	<span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Config._parse_config"><a class="viewcode-back" href="../../book.html#rp2book.book.Config._parse_config">[docs]</a>	<span class="k">def</span> <span class="nf">_parse_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parsing the config file, which may either be a JSON file (ie, suffix &quot;.js&quot; or &quot;.json&quot;) or a YAML file (ie, suffix &quot;.yaml&quot;).</span>

<span class="sd">        In fact, the fallback format is also JSON, so if no suffix is matched, that is used.</span>

<span class="sd">        :param config_file:</span>
<span class="sd">        :return: parsed config</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
		<span class="k">if</span> <span class="n">config_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
			<span class="kn">import</span> <span class="nn">yaml</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="kn">import</span> <span class="nn">json</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
				<span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div>
	<span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Title: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;ID: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Date: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Editors: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Authors: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Sources: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Target: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Directory to be removed: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">toRemoveDir</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;URI replacement patterns: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">uri_patterns</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Chapter objects </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">chapters</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Overall OPF object </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">opf</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Overall NAV object </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nav</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Overall NCX object </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncx</span>
		<span class="n">retval</span> <span class="o">+=</span> <span class="s2">&quot;Overall Cover object </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover</span>
		<span class="k">return</span> <span class="n">retval</span>

</div>
<div class="viewcode-block" id="Book"><a class="viewcode-back" href="../../book.html#rp2book.book.Book">[docs]</a><span class="k">class</span> <span class="nc">Book</span><span class="p">:</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Top level creator of the the combined book. The following steps are performed:</span>

<span class="sd">    1. a :py:class:`.chapter.Chapter` object is created for each chapter, yielding information like individual table of contents, date, authors, etc</span>
<span class="sd">    2. the “top level” configuration information are created (through calls to the :py:func:`.package.generate_opf`, :py:func:`.package.generate_nav`, :py:func:`.package.generate_cover`, and :py:func:`.package.generate_ncx` functions), yielding a series of :py:class:`ElementTree.Element` objects</span>
<span class="sd">    3. the various files are copied and/or generated into a target directory (in the :py:meth:`_generate_files` method)</span>
<span class="sd">    4. the `Overview.xhtml` files are modified by changing the mutual references (through the :py:func:`.overview.convert_overviews` function)</span>
<span class="sd">    5. the final target is zipped into an `epub` file (if applicable)</span>
<span class="sd">    6. the target directory is removed (if applicable)</span>

<span class="sd">    :param json_config: file name for the json or yaml configuration file</span>
<span class="sd">    :type json_config: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
	<span class="c1"># noinspection PyPep8</span>
	<span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_config</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
		<span class="k">with</span> <span class="n">Config</span><span class="p">(</span><span class="n">json_config</span><span class="p">)</span> <span class="k">as</span> <span class="n">config</span><span class="p">:</span>
			<span class="c1"># Extract information for chapters</span>
			<span class="n">config</span><span class="o">.</span><span class="n">chapters</span> <span class="o">=</span> <span class="p">[</span><span class="n">Chapter</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>

			<span class="c1"># Some generic metadata</span>
			<span class="n">config</span><span class="o">.</span><span class="n">date</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">date</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">chapters</span><span class="p">])</span>

			<span class="k">def</span> <span class="nf">intelligent_concat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
				<span class="sd">&quot;&quot;&quot;Add elements of the second list to the first only if it is not there already.</span>
<span class="sd">                Using sets was not really an option because sets do not necessary keep the order, and this was simpler then creating a separate OrderedSet class.</span>
<span class="sd">                :param x: array</span>
<span class="sd">                :param y: array</span>
<span class="sd">                :returns: the &quot;concatenated&quot; array</span>
<span class="sd">                &quot;&quot;&quot;</span>
				<span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">y</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
			<span class="n">config</span><span class="o">.</span><span class="n">editors</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">intelligent_concat</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">editors</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">chapters</span><span class="p">],</span> <span class="p">[])</span>
			<span class="n">config</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">intelligent_concat</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">authors</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">chapters</span><span class="p">],</span> <span class="p">[])</span>

			<span class="n">config</span><span class="o">.</span><span class="n">ncx</span>   <span class="o">=</span> <span class="n">generate_ncx</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">nav</span>   <span class="o">=</span> <span class="n">generate_nav</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">cover</span> <span class="o">=</span> <span class="n">generate_cover</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
			<span class="n">config</span><span class="o">.</span><span class="n">opf</span>   <span class="o">=</span> <span class="n">generate_opf</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

			<span class="bp">self</span><span class="o">.</span><span class="n">_generate_files</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
			<span class="n">convert_overviews</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

			<span class="c1"># Finalizing the output: possibly generate an epub file, and remove the sources</span>
			<span class="k">if</span> <span class="n">package</span><span class="p">:</span>
				<span class="c1"># We have to get a list of all the files to be added</span>
				<span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
				<span class="n">container_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;META-INF&quot;</span><span class="p">,</span><span class="s2">&quot;container.xml&quot;</span><span class="p">)</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">target</span><span class="p">):</span>
					<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
						<span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
						<span class="c1"># Remove the files that must be on top, ie, must be put into the zip file explicitly; see below</span>
						<span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="s2">&quot;mimetype&quot;</span> <span class="ow">or</span> <span class="n">source</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">container_path</span><span class="p">):</span>
							<span class="k">continue</span>
						<span class="n">target</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
						<span class="n">target</span> <span class="o">=</span> <span class="n">target</span> <span class="k">if</span> <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="k">else</span> <span class="n">target</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):]</span>
						<span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>
				<span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;.epub&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">the_book</span><span class="p">:</span>
					<span class="c1"># These two files should be on the top of the zip file, the first without compression</span>
					<span class="c1"># (This is part of the epub spec)</span>
					<span class="n">the_book</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="s2">&quot;mimetype&quot;</span><span class="p">),</span> <span class="s2">&quot;mimetype&quot;</span><span class="p">,</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_STORED</span><span class="p">)</span>
					<span class="n">the_book</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">container_path</span><span class="p">),</span> <span class="n">container_path</span><span class="p">)</span>
					<span class="c1"># The rest of the content can just be done as it comes</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span> <span class="n">the_book</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
			<span class="k">if</span> <span class="ow">not</span> <span class="n">folder</span><span class="p">:</span>
				<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>

		<span class="c1"># This is mainly needed for debug...</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">config</span>

	<span class="nd">@property</span>
	<span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;The overall book data, collected from the configuration file and the chapters.&quot;&quot;&quot;</span>
		<span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span>

	<span class="c1"># noinspection PyPep8,PyUnresolvedReferences</span>
	<span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Book._generate_files"><a class="viewcode-back" href="../../book.html#rp2book.book.Book._generate_files">[docs]</a>	<span class="k">def</span> <span class="nf">_generate_files</span><span class="p">(</span><span class="n">book_data</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate all the files. This means</span>

<span class="sd">        1. The target folder is created</span>
<span class="sd">        2. Each chapter is copied into the target, though removing the `META-INF` and `mimetype` files</span>
<span class="sd">        3. Style files and logos, needed for the overall cover page, are copied into the top level folder</span>
<span class="sd">        3. The various top level configuration files (OPF, NAV, NCX, and cover) are added to the folder (serializing the corresponding ElementTree.Element objects)</span>

<span class="sd">        :param book_data: The book data</span>
<span class="sd">        :type book_data: :py:class:`.Config` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
		<span class="c1"># All the file copying business...</span>
		<span class="c1"># The target directory should either be created, if not yet there. If it is there, it should be emptied first</span>
		<span class="c1"># Note that the target path is a simple file name, not a full path!</span>

		<span class="c1"># Lists of various file names with different actions</span>
		<span class="c1"># Files to copy from the first chapter to the top level</span>
		<span class="n">to_copy</span>   <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;META-INF&quot;</span><span class="p">,</span><span class="s2">&quot;container.xml&quot;</span><span class="p">),</span>
					 <span class="s2">&quot;mimetype&quot;</span><span class="p">,</span>
					 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;StyleSheets&quot;</span><span class="p">,</span><span class="s2">&quot;TR&quot;</span><span class="p">,</span><span class="s2">&quot;base.css&quot;</span><span class="p">),</span>
					 <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Icons&quot;</span><span class="p">,</span> <span class="s2">&quot;w3c_main.png&quot;</span><span class="p">)</span>
					 <span class="p">]</span>
		<span class="c1"># Files to remove from each chapter</span>
		<span class="n">to_remove</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mimetype&quot;</span><span class="p">,</span> <span class="s2">&quot;nav.xhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;package.opf&quot;</span><span class="p">,</span> <span class="s2">&quot;toc.ncx&quot;</span><span class="p">]</span>
		<span class="c1"># Files to add to the top level; the values are ElementTree Elements; the third item is the default</span>
		<span class="c1"># file name, to make things look proper when the XML is serialized.</span>
		<span class="n">to_add</span>    <span class="o">=</span> <span class="p">[</span>
			<span class="p">(</span><span class="n">book_data</span><span class="o">.</span><span class="n">opf</span><span class="p">,</span> <span class="s2">&quot;package.opf&quot;</span><span class="p">,</span> <span class="s2">&quot;http://www.idpf.org/2007/opf&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">book_data</span><span class="o">.</span><span class="n">nav</span><span class="p">,</span> <span class="s2">&quot;nav.xhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">book_data</span><span class="o">.</span><span class="n">ncx</span><span class="p">,</span> <span class="s2">&quot;toc.ncx&quot;</span><span class="p">,</span> <span class="s2">&quot;http://www.daisy.org/z3986/2005/ncx/&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">book_data</span><span class="o">.</span><span class="n">cover</span><span class="p">,</span> <span class="s2">&quot;cover.xhtml&quot;</span><span class="p">,</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">)</span>
		<span class="p">]</span>

		<span class="c1"># The target directory for the book</span>
		<span class="n">target</span> <span class="o">=</span> <span class="n">book_data</span><span class="o">.</span><span class="n">target</span>

		<span class="c1"># The target directory should be emptied and created</span>
		<span class="k">try</span><span class="p">:</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
		<span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
			<span class="k">pass</span>
		<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

		<span class="c1"># Each chapter, ie, the corresponding book directory, must be copied to the target</span>
		<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">book_data</span><span class="o">.</span><span class="n">chapters</span><span class="p">:</span>
			<span class="n">c_target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">c_target</span><span class="p">)</span>

			<span class="c1"># some files should be removed from that target, though</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_target</span><span class="p">,</span> <span class="s2">&quot;META-INF&quot;</span><span class="p">))</span>
			<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c_target</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

		<span class="c1"># Some elements should be copied from one of the chapters into the &#39;main&#39; part</span>
		<span class="n">s_chapter</span> <span class="o">=</span> <span class="n">book_data</span><span class="o">.</span><span class="n">chapters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span>
		<span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">to_copy</span><span class="p">:</span>
			<span class="c1"># Copy one file, possibly creating the directories on the fly</span>
			<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tc</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
				<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">tc</span><span class="p">)))</span>
			<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s_chapter</span><span class="p">,</span> <span class="n">tc</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tc</span><span class="p">))</span>

		<span class="c1"># Write the top level admin files, generated from the chapters, into the the final directory (serializing the content on the fly)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">f_element_tree</span><span class="p">,</span> <span class="n">f_name</span><span class="p">,</span> <span class="n">f_namespace</span><span class="p">)</span> <span class="ow">in</span> <span class="n">to_add</span><span class="p">:</span>

			<span class="n">ET</span><span class="o">.</span><span class="n">register_namespace</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">f_namespace</span><span class="p">)</span>
			<span class="n">content</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
			<span class="n">f_element_tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;xml&quot;</span><span class="p">)</span>
			<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f_name</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_file</span><span class="p">:</span>
				<span class="n">f_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
			<span class="n">content</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
	<span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
</pre></div></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Ivan Herman.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>